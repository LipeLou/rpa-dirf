<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EFD-REINF - Declara√ß√£o de Rendimentos</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 20px;
        }
        
        .logo {
            font-size: 20px;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #666;
            font-size: 14px;
        }
        
        .step {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .step-title {
            color: #1e3c72;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        
        .step-number {
            background: #1e3c72;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 12px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }
        
        input[type="text"],
        input[type="date"],
        select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus,
        input[type="date"]:focus,
        select:focus {
            outline: none;
            border-color: #1e3c72;
        }
        
        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(30, 60, 114, 0.3);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .hidden {
            display: none !important;
        }
        
        .dependent-item,
        .health-plan-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .dependent-info,
        .health-plan-info {
            flex: 1;
        }
        
        .dependent-actions,
        .health-plan-actions {
            display: flex;
            gap: 5px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 10px;
        }
        
        .modal-title {
            color: #1e3c72;
            font-size: 18px;
            font-weight: bold;
        }
        
        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
        }
        
        .close:hover {
            color: #000;
        }
        
        .form-actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .back-link {
            color: #1e3c72;
            text-decoration: none;
            font-weight: bold;
            margin-bottom: 20px;
            display: inline-block;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üìã EFD-REINF - Declara√ß√£o de Rendimentos</div>
            <div class="subtitle">Formul√°rio para declara√ß√£o de rendimentos pagos a pessoas f√≠sicas</div>
        </div>
        
        <a href="/" class="back-link">‚Üê Voltar ao Menu</a>
        
        <form id="efdForm" action="/submit_efd" method="POST">
            <!-- Campos hidden para enviar os dados dos arrays -->
            <input type="hidden" id="dependentesData" name="dependentes" value="">
            <input type="hidden" id="planosData" name="planos_saude" value="">
            <input type="hidden" id="dependentesPlanosData" name="dependentes_planos" value="">
            <!-- Etapa 1: Dados Iniciais -->
            <div class="step" id="step1">
                <div class="step-title">
                    <div class="step-number">1</div>
                    Dados Iniciais
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="data">Data *</label>
                        <input type="text" id="data" name="data" placeholder="DD/MM/AAAA" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="cnpj">CNPJ *</label>
                        <input type="text" id="cnpj" name="cnpj" placeholder="00.000.000/0000-00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="cpf">CPF *</label>
                        <input type="text" id="cpf" name="cpf" placeholder="000.000.000-00" required>
                    </div>
                </div>
                
                <button type="button" class="btn" onclick="proximoPasso()">Continuar</button>
            </div>
            
            <!-- Etapa 2: Dependentes e Plano de Sa√∫de -->
            <div class="step hidden" id="step2">
                <div class="step-title">
                    <div class="step-number">2</div>
                    Dependentes e Plano de Sa√∫de
                </div>
                
                <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                    <button type="button" class="btn" onclick="abrirModalDependente()">
                        ‚ûï Incluir Dependente (Opcional)
                    </button>
                    <button type="button" class="btn" onclick="abrirModalPlanoSaude()">
                        üè• Incluir Plano de Sa√∫de *
                    </button>
                </div>
                
                <!-- Lista de Dependentes -->
                <div id="dependentesList" style="margin-bottom: 20px;">
                    <h4 style="color: #1e3c72; margin-bottom: 10px;">Dependentes Cadastrados:</h4>
                    <div id="dependentesContainer"></div>
                </div>
                
                <!-- Lista de Planos de Sa√∫de -->
                <div id="planosList" style="margin-bottom: 20px;">
                    <h4 style="color: #1e3c72; margin-bottom: 10px;">Planos de Sa√∫de Cadastrados:</h4>
                    <div id="planosContainer"></div>
                </div>
                
                <!-- Bot√£o para adicionar informa√ß√µes dos dependentes (s√≥ aparece ap√≥s adicionar plano) -->
                <div id="dependentePlanoSection" class="hidden">
                    <button type="button" class="btn btn-success" onclick="abrirModalDependentePlano()">
                        üí∞ Adicionar Informa√ß√µes dos Dependentes
                    </button>
                </div>
                
                <div style="margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="voltarPasso()">Voltar</button>
                    <button type="button" class="btn btn-success" onclick="finalizarFormulario()">Enviar Declara√ß√£o</button>
                </div>
            </div>
            
        </form>
    </div>
    
    <!-- Modal para Adicionar Dependente -->
    <div id="modalDependente" class="modal hidden" onclick="fecharModalDependente()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Adicionar Dependente</div>
                <button class="close" onclick="fecharModalDependente()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="dependenteCpf">CPF do Dependente *</label>
                <input type="text" id="dependenteCpf" placeholder="000.000.000-00" required>
            </div>
            
            <div class="form-group">
                <label for="relacaoDependencia">Rela√ß√£o de Depend√™ncia *</label>
                <select id="relacaoDependencia" required onchange="toggleAgregadoOutros()">
                    <option value="">Selecione...</option>
                    <option value="conjuge">C√¥njuge</option>
                    <option value="companheiro">Companheiro(a) com o(a) qual tenha filho ou viva h√° mais de 5 (cinco) anos ou possua declara√ß√£o de uni√£o est√°vel</option>
                    <option value="filho">Filho(a) ou enteado(a)</option>
                    <option value="irmao">Irm√£o(√£), neto(a) ou bisneto(a) sem arrimo dos pais, do(a) qual detenha a guarda judicial</option>
                    <option value="pais">Pais, av√≥s e bisav√≥s</option>
                    <option value="menor">Menor pobre do qual detenha a guarda judicial</option>
                    <option value="incapaz">A pessoa absolutamente incapaz, da qual seja tutor ou curador</option>
                    <option value="ex_conjuge">Ex-c√¥njuge</option>
                    <option value="agregado">Agregado/Outros</option>
                </select>
            </div>
            
            <div class="form-group hidden" id="agregadoOutrosGroup">
                <label for="agregadoOutros">Especificar Rela√ß√£o *</label>
                <input type="text" id="agregadoOutros" placeholder="Descreva a rela√ß√£o de depend√™ncia">
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="fecharModalDependente()">Cancelar</button>
                <button type="button" class="btn" onclick="adicionarDependente()">Adicionar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionar Plano de Sa√∫de -->
    <div id="modalPlanoSaude" class="modal hidden" onclick="fecharModalPlanoSaude()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Adicionar Plano de Sa√∫de</div>
                <button class="close" onclick="fecharModalPlanoSaude()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="planoCnpj">CNPJ do Plano *</label>
                <input type="text" id="planoCnpj" placeholder="00.000.000/0000-00" required>
            </div>
            
            <div class="form-group">
                <label for="valorPago">Valor Pago *</label>
                <input type="text" id="valorPago" placeholder="0,00" required>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="fecharModalPlanoSaude()">Cancelar</button>
                <button type="button" class="btn" onclick="adicionarPlanoSaude()">Adicionar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal para Adicionar Informa√ß√µes dos Dependentes -->
    <div id="modalDependentePlano" class="modal hidden" onclick="fecharModalDependentePlano()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">Informa√ß√µes dos Dependentes</div>
                <button class="close" onclick="fecharModalDependentePlano()">&times;</button>
            </div>
            
            <div class="form-group">
                <label for="dependenteSelecionado">Dependente *</label>
                <select id="dependenteSelecionado" required>
                    <option value="">Selecione um dependente...</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="valorDependente">Valor *</label>
                <input type="text" id="valorDependente" placeholder="0,00" required>
            </div>
            
            <div style="text-align: right; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="fecharModalDependentePlano()">Cancelar</button>
                <button type="button" class="btn" onclick="adicionarDependentePlano()">Adicionar</button>
            </div>
        </div>
    </div>
    
    <script>
        let dependentes = [];
        let planosSaude = [];
        let dependentesPlanos = [];
        let passoAtual = 1;
        
        function proximoPasso() {
            if (passoAtual === 1) {
                // Validar dados iniciais
                const data = document.getElementById('data').value;
                const cnpj = document.getElementById('cnpj').value;
                const cpf = document.getElementById('cpf').value;
                
                if (!data || !cnpj || !cpf) {
                    alert('Por favor, preencha todos os campos obrigat√≥rios.');
                    return;
                }
                
                document.getElementById('step1').classList.add('hidden');
                document.getElementById('step2').classList.remove('hidden');
                passoAtual = 2;
            }
        }
        
        function voltarPasso() {
            if (passoAtual === 2) {
                document.getElementById('step2').classList.add('hidden');
                document.getElementById('step1').classList.remove('hidden');
                passoAtual = 1;
            }
        }
        
        function finalizarFormulario() {
            // Validar se pelo menos um plano de sa√∫de foi adicionado
            if (planosSaude.length === 0) {
                alert('Por favor, adicione pelo menos um plano de sa√∫de.');
                return;
            }
            
            // Preparar dados para envio
            document.getElementById('dependentesData').value = JSON.stringify(dependentes);
            document.getElementById('planosData').value = JSON.stringify(planosSaude);
            document.getElementById('dependentesPlanosData').value = JSON.stringify(dependentesPlanos);
            
            // Enviar formul√°rio diretamente
            document.getElementById('efdForm').submit();
        }
        
        
        // Fun√ß√£o para controlar visibilidade do campo "Agregado/Outros"
        function toggleAgregadoOutros() {
            const relacaoSelect = document.getElementById('relacaoDependencia');
            const agregadoGroup = document.getElementById('agregadoOutrosGroup');
            const agregadoInput = document.getElementById('agregadoOutros');
            
            if (relacaoSelect.value === 'agregado') {
                agregadoGroup.classList.remove('hidden');
                agregadoInput.required = true;
            } else {
                agregadoGroup.classList.add('hidden');
                agregadoInput.required = false;
                agregadoInput.value = ''; // Limpar o campo quando esconder
            }
        }
        
        // Fun√ß√µes dos Modais
        function abrirModalDependente() {
            console.log('Abrindo modal de dependente...');
            // Limpar campos antes de abrir
            document.getElementById('dependenteCpf').value = '';
            document.getElementById('relacaoDependencia').value = '';
            document.getElementById('agregadoOutros').value = '';
            document.getElementById('agregadoOutrosGroup').classList.add('hidden');
            document.getElementById('modalDependente').classList.remove('hidden');
        }
        
        function fecharModalDependente() {
            document.getElementById('modalDependente').classList.add('hidden');
            document.getElementById('dependenteCpf').value = '';
            document.getElementById('relacaoDependencia').value = '';
            document.getElementById('agregadoOutros').value = '';
            document.getElementById('agregadoOutrosGroup').classList.add('hidden');
        }
        
        function abrirModalPlanoSaude() {
            // Limpar campos antes de abrir
            document.getElementById('planoCnpj').value = '';
            document.getElementById('valorPago').value = '';
            document.getElementById('modalPlanoSaude').classList.remove('hidden');
        }
        
        function fecharModalPlanoSaude() {
            document.getElementById('modalPlanoSaude').classList.add('hidden');
            document.getElementById('planoCnpj').value = '';
            document.getElementById('valorPago').value = '';
        }
        
        function abrirModalDependentePlano() {
            if (dependentes.length === 0) {
                alert('Adicione pelo menos um dependente primeiro.');
                return;
            }
            
            // Limpar campos antes de abrir
            document.getElementById('dependenteSelecionado').value = '';
            document.getElementById('valorDependente').value = '';
            
            // Atualizar select com dependentes
            const select = document.getElementById('dependenteSelecionado');
            select.innerHTML = '<option value="">Selecione um dependente...</option>';
            dependentes.forEach(dep => {
                const option = document.createElement('option');
                option.value = dep.cpf;
                option.textContent = dep.cpf;
                select.appendChild(option);
            });
            
            document.getElementById('modalDependentePlano').classList.remove('hidden');
        }
        
        function fecharModalDependentePlano() {
            document.getElementById('modalDependentePlano').classList.add('hidden');
            document.getElementById('dependenteSelecionado').value = '';
            document.getElementById('valorDependente').value = '';
        }
        
        // Fun√ß√µes de Adicionar
        function adicionarDependente() {
            console.log('Adicionando dependente...');
            const cpf = document.getElementById('dependenteCpf').value;
            const relacao = document.getElementById('relacaoDependencia').value;
            const agregadoOutros = document.getElementById('agregadoOutros').value;
            
            console.log('CPF:', cpf, 'Rela√ß√£o:', relacao, 'Agregado/Outros:', agregadoOutros);
            
            if (!cpf || !relacao) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            // Se for "Agregado/Outros", verificar se o campo espec√≠fico foi preenchido
            if (relacao === 'agregado' && !agregadoOutros.trim()) {
                alert('Por favor, especifique a rela√ß√£o de depend√™ncia.');
                return;
            }
            
            // Verificar se CPF j√° existe
            if (dependentes.find(dep => dep.cpf === cpf)) {
                alert('Este CPF j√° foi adicionado como dependente.');
                return;
            }
            
            // Criar objeto dependente com rela√ß√£o completa
            let relacaoCompleta = relacao;
            if (relacao === 'agregado' && agregadoOutros.trim()) {
                relacaoCompleta = `Agregado/Outros: ${agregadoOutros.trim()}`;
            }
            
            dependentes.push({ cpf, relacao: relacaoCompleta });
            console.log('Dependentes:', dependentes);
            
            atualizarListaDependentes();
            fecharModalDependente();
        }
        
        function adicionarPlanoSaude() {
            console.log('Adicionando plano de sa√∫de...');
            const cnpj = document.getElementById('planoCnpj').value;
            const valor = document.getElementById('valorPago').value;
            
            console.log('CNPJ:', cnpj, 'Valor:', valor);
            
            if (!cnpj || !valor) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            planosSaude.push({ cnpj, valor });
            console.log('Planos de sa√∫de:', planosSaude);
            
            atualizarListaPlanos();
            fecharModalPlanoSaude();
            
            // Mostrar bot√£o para adicionar informa√ß√µes dos dependentes
            console.log('Mostrando bot√£o de informa√ß√µes dos dependentes...');
            document.getElementById('dependentePlanoSection').classList.remove('hidden');
        }
        
        function adicionarDependentePlano() {
            const cpf = document.getElementById('dependenteSelecionado').value;
            const valor = document.getElementById('valorDependente').value;
            
            if (!cpf || !valor) {
                alert('Por favor, preencha todos os campos.');
                return;
            }
            
            // Verificar se j√° existe informa√ß√£o para este dependente
            if (dependentesPlanos.find(dp => dp.cpf === cpf)) {
                alert('J√° existe informa√ß√£o para este dependente.');
                return;
            }
            
            dependentesPlanos.push({ cpf, valor });
            atualizarListaDependentesPlanos();
            fecharModalDependentePlano();
        }
        
        // Fun√ß√µes de Atualizar Listas
        function atualizarListaDependentes() {
            console.log('Atualizando lista de dependentes...');
            const container = document.getElementById('dependentesContainer');
            container.innerHTML = '';
            
            console.log('Dependentes para mostrar:', dependentes);
            
            dependentes.forEach((dep, index) => {
                const div = document.createElement('div');
                div.className = 'dependent-item';
                div.innerHTML = `
                    <div class="dependent-info">
                        <strong>CPF:</strong> ${dep.cpf} | <strong>Rela√ß√£o:</strong> ${dep.relacao}
                    </div>
                    <div class="dependent-actions">
                        <button type="button" class="btn btn-danger" onclick="removerDependente(${index})">Remover</button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            console.log('Lista de dependentes atualizada');
        }
        
        function atualizarListaPlanos() {
            const container = document.getElementById('planosContainer');
            container.innerHTML = '';
            
            planosSaude.forEach((plano, index) => {
                const div = document.createElement('div');
                div.className = 'health-plan-item';
                div.innerHTML = `
                    <div class="health-plan-info">
                        <strong>CNPJ:</strong> ${plano.cnpj} | <strong>Valor:</strong> R$ ${plano.valor}
                    </div>
                    <div class="health-plan-actions">
                        <button type="button" class="btn btn-danger" onclick="removerPlanoSaude(${index})">Remover</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        function atualizarListaDependentesPlanos() {
            // Esta fun√ß√£o seria chamada se tiv√©ssemos uma lista visual dos dependentes com planos
            console.log('Dependentes com planos:', dependentesPlanos);
        }
        
        // Fun√ß√µes de Remover
        function removerDependente(index) {
            dependentes.splice(index, 1);
            atualizarListaDependentes();
        }
        
        function removerPlanoSaude(index) {
            planosSaude.splice(index, 1);
            atualizarListaPlanos();
            
            // Se n√£o h√° mais planos, esconder bot√£o de dependentes
            if (planosSaude.length === 0) {
                document.getElementById('dependentePlanoSection').classList.add('hidden');
            }
        }
        
        // Definir data atual
        document.addEventListener('DOMContentLoaded', function() {
            console.log('P√°gina carregada, garantindo que modais estejam fechados...');
            const hoje = new Date();
            const dia = String(hoje.getDate()).padStart(2, '0');
            const mes = String(hoje.getMonth() + 1).padStart(2, '0');
            const ano = hoje.getFullYear();
            const dataFormatada = `${dia}/${mes}/${ano}`;
            document.getElementById('data').value = dataFormatada;
            
            // Garantir que os modais estejam fechados ao carregar a p√°gina
            const modalDependente = document.getElementById('modalDependente');
            const modalPlanoSaude = document.getElementById('modalPlanoSaude');
            const modalDependentePlano = document.getElementById('modalDependentePlano');
            
            modalDependente.classList.add('hidden');
            modalPlanoSaude.classList.add('hidden');
            modalDependentePlano.classList.add('hidden');
            
            console.log('Modais fechados:', {
                dependente: modalDependente.classList.contains('hidden'),
                planoSaude: modalPlanoSaude.classList.contains('hidden'),
                dependentePlano: modalDependentePlano.classList.contains('hidden')
            });
        });
    </script>
</body>
</html>
